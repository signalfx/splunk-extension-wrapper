version: 2.1

commands:
  save_test_results:
    description: Collect and archive test results from `dir`.
    parameters:
      dir:
        type: string
        default: ~/testresults
    steps:
      - store_test_results:
          path: << parameters.dir >>
      - store_artifacts:
          path: << parameters.dir >>
  go_mod_download:
    description: Download go modules required by the project
    steps:
      - restore_cache:
          key: v1-go-mod-{{ checksum "go.mod" }}-{{ checksum "go.sum" }}
      - run:
          name: Install dependencies
          command: |
            [[ -d /go/pkg/mod/cache ]] && exit 0
            # retry up to 3 times in case of network issues
            for i in $(seq 1 3); do
                go mod download && exit 0
                sleep 10
            done
            exit 1
      - save_cache:
          key: v1-go-mod-{{ checksum "go.mod" }}-{{ checksum "go.sum" }}
          paths:
            - /go/pkg/mod
  persist_regions:
    description: Persists supported regions to a workspace
    steps:
      - persist_to_workspace:
          root: bin
          paths:
            - ./regions
  persist_versions:
    description: Persists supported regions to a workspace
    steps:
      - persist_to_workspace:
          root: bin
          paths:
            - ./versions
  restore_bin:
    description: Restores the bin directory previously persisted in a workspace
    steps:
      - run: mkdir bin
      - attach_workspace:
          at: bin

orbs:
  aws-cli: circleci/aws-cli@1.4.0

jobs:
  test:
    docker:
      - image: circleci/golang:1.15.5
    steps:
      - checkout
      - go_mod_download
      - run:
          name: Run tests
          command: |
            mkdir ~/testresults
            (cd /tmp; GO111MODULE=on go get gotest.tools/gotestsum)
            CGO_ENABLED=0 gotestsum --format short-verbose --junitfile ~/testresults/unit.xml --raw-command -- go test --json -p 4 ./...
      - save_test_results
  package:
    docker:
      - image: circleci/golang:1.15.5
    steps:
      - checkout
      - go_mod_download
      - run:
          name: Package the Extension
          command: make
      - persist_to_workspace:
          root: bin
          paths:
            - ./*.zip
  publish_layer_version:
    executor: aws-cli/default
    steps:
      - aws-cli/setup
      - checkout
      - restore_bin # restores the layer artefact persisted in a workspace
      - run:
          name: List supported regions
          command: make supported-regions
      - persist_regions
      - run:
          name: Publish layer version
          command: make add-layer-version
      - store_artifacts:
          path: bin/regions
      - store_artifacts:
          path: bin/versions
      - persist_versions
  run_test:
    executor: aws-cli/default
    parameters:
      region:
        type: string
    steps:
      - aws-cli/setup
      - checkout
      - restore_bin # restores the file with layers versions
      - run:
          name: Run tests
          command: make run-test REGION=<< parameters.region >>
  verify_test_results:
    docker:
      - image: cimg/node:15.10.0
    steps:
      - checkout
      - run:
          name: Verify test results
          command: make verify-test EXPECTED_INVOCATION_COUNT=50
          no_output_timeout: 1m
  make_layer_version_public:
    executor: aws-cli/default
    steps:
      - aws-cli/setup
      - checkout
      - restore_bin # restores supported regions and layer versions persisted in a workspace
      - run:
          name: Add global permission to layer version
          command: make add-layer-version-permission

workflows:
  workflow:
    jobs:
      - test
      - package
      - publish_layer_version:
          filters:
            branches:
              only:
                - master
                - /pipeline-.*/
          requires:
            - test
            - package
      - run_test:
          matrix:
            parameters:
              region: ["us-east-1", "eu-central-1", "af-south-1", "us-west-2", "ap-northeast-2"]
          requires:
            - publish_layer_version
      - verify_test_results:
          requires:
            - run_test
      - confirm_making_public:
          filters:
            branches:
              only: master
          type: approval
          requires:
              - verify_test_results
      - make_layer_version_public:
          requires:
            - confirm_making_public
